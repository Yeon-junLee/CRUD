<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>게시판</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            const userId = user;  // 사용자 ID를 JavaScript 변수에 저장

            fetchPosts();

            $('#create-form').on('submit', function(event) {
                event.preventDefault();
                const title = $('#title').val();
                const content = $('#content').val();
                $.ajax({
                    url: '/api/posts',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId, title, content }),
                    success: function(response) {
                        $('#create-modal').hide();
                        fetchPosts();
                    },
                    error: function(response) {
                        alert(response.responseJSON.error);
                    }
                });
            });
        });

        function fetchPosts() {
            $.ajax({
                url: '/api/posts',
                method: 'GET',
                success: function(posts) {
                    const postList = $('#post-list');
                    postList.empty();
                    posts.forEach(post => {
                        postList.append(`
                            <li>
                                <h2><a href="/post/${post._id}">${post.title}</a></h2>
                                <p>${post.content.slice(0, 100)}...</p>
                                <p>작성자: ${post.userId}</p>
                            </li>
                        `);
                    });
                },
                error: function(response) {
                    alert(response.responseJSON.error);
                }
            });
        }

        function openCreateModal() {
            $('#create-modal').show();
        }

        function closeCreateModal() {
            $('#create-modal').hide();
        }
    </script>
</head>
<body>
    <h1>게시판</h1>
    <p>안녕하세요, {{ user }}!</p>
    <a href="{{ url_for('logout') }}">로그아웃</a>
    <button onclick="openCreateModal()">새 글 작성</button>
    <ul id="post-list"></ul>

    <div id="create-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCreateModal()">&times;</span>
            <h2>새 글 작성</h2>
            <form id="create-form">
                <label for="title">제목</label>
                <input type="text" id="title" name="title" style="width: 100%;">

                <label for="content">내용</label>
                <textarea id="content" name="content" style="width: 100%; height: 300px;"></textarea>
                
                <button type="submit">작성</button>
            </form>
        </div>
    </div>

    <style>
        /* Modal CSS */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</body>
</html>
